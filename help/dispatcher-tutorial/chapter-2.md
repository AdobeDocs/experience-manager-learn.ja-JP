---
title: 第2章 — Dispatcherインフラストラクチャ
description: パブリッシュおよびDispatcherのトポロジを理解します。 最も一般的なトポロジと設定について説明します。
feature: Dispatcher
topic: アーキテクチャ
role: Architect
level: Beginner
source-git-commit: d9714b9a291ec3ee5f3dba9723de72bb120d2149
workflow-type: tm+mt
source-wordcount: '1866'
ht-degree: 0%

---


# 第2章 — インフラ

## キャッシュインフラストラクチャの設定

このシリーズの第1章では、パブリッシュシステムとDispatcherの基本トポロジを導入しました。 パブリッシュサーバーとDispatcherサーバーのセットは、予想される負荷、データセンターのトポロジ、および必要なフェイルオーバープロパティに応じて、様々な方法で設定できます。

最も一般的なトポロジをスケッチし、その利点とその欠点を説明します。 もちろん、リストは包括的ではありません。 唯一の制限は、あなたの想像力です。

### 「レガシー」設定

初期の頃は、潜在的な訪問者数が少なく、ハードウェアが高価で、Webサーバは現在のようにビジネスクリティカルではないと考えられていました。 一般的な設定では、2つ以上のパブリッシュシステムの前に、1つのDispatcherをロードバランサーとキャッシュとして機能させます。 DispatcherのコアにあるApacheサーバーは非常に安定しており、ほとんどの設定で、適切な量の要求に対応できます。

![「レガシー」Dispatcherの設定 — 現在の標準ではあまり一般的ではありません](assets/chapter-2/legacy-dispatcher-setup.png)

*「レガシー」Dispatcherの設定 — 現在の標準ではあまり一般的ではありません*

<br> 

Dispatcherが名前を受け取った場所：要求を出すのが基本でした 現在必要なパフォーマンスと安定性の高い要求を満たすことができないため、この設定は今後あまり一般的ではありません。

### 多足セットアップ

最近では、少し異なるトポロジが一般的です。 複数の脚を持つトポロジでは、パブリッシュサーバーごとに1つのDispatcherが存在します。 AEMインフラストラクチャの前に、専用の（ハードウェア）ロードバランサが設置され、次の2つ以上の脚にリクエストがディスパッチされます。

![最新の「標準」Dispatcherセットアップ — 扱いやすく、保守が容易](assets/chapter-2/modern-standard-dispatcher-setup.png)

*最新の「標準」Dispatcherセットアップ — 扱いやすく、保守が容易*

<br> 

この種の設定の理由は次の通りです。

1. Webサイトは、平均して、過去よりもはるかに多くのトラフィックを提供します。 したがって、「Apacheインフラストラクチャ」を拡張する必要があります。

2. 「従来の」設定では、Dispatcherレベルの冗長性が提供されませんでした。 Apacheサーバーがダウンした場合、Webサイト全体に到達できませんでした。

3. Apacheサーバーは安価です。 オープンソースに基づいており、仮想データセンターがある場合は、非常に高速にプロビジョニングできます。

4. この設定により、「ローリング」または「千鳥」の更新シナリオを簡単に実行できます。 新しいソフトウェアパッケージをPublish 1にインストールする際に、Dispatcher 1をシャットダウンするだけです。 インストールが完了し、内部ネットワークから十分にスモークテスト済みのPublish 1を作成したら、Dispatcher 1のキャッシュをクリーンし、Dispatcher 2を停止してPublish 2のメンテナンスを行いながら、新たに起動します。

5. この設定では、キャッシュの無効化が非常に簡単で決定的になります。 1つのパブリッシュシステムが1つのDispatcherに接続されるだけなので、無効にするDispatcherは1つだけです。 無効化の順序とタイミングは簡単です。

### 「スケールアウト」設定

Apacheサーバーは安くプロビジョニングが容易なので、そのレベルをもう少し拡張してみましょう。 各パブリッシュサーバーの前に2つ以上のDispatcherがないのはなぜですか。

![「スケールアウト」設定 — 一部のアプリケーション領域がありますが、制限事項と注意事項もあります。](assets/chapter-2/scale-out-setup.png)

*「スケールアウト」設定 — 一部のアプリケーション領域がありますが、制限事項と注意事項もあります。*

<br> 

絶対にできる！ そして、その設定には多くの有効なアプリケーションシナリオがあります。 しかし、考慮すべきいくつかの制限や複雑さもあります。

#### 無効化

各パブリッシュシステムは、複数のDispatcherに接続されています。コンテンツが変更された場合は、それぞれを無効にする必要があります。

#### メンテナンス

Dispatcherシステムとパブリッシュシステムの初期設定は、言うまでもなく、もう少し複雑です。 しかし、「ローリング」リリースの取り組みも、もう少し高いことにも留意してください。 AEMシステムの実行中に更新が可能で、必要です。 しかし、彼らが積極的に要求を提供している間はそうしないのは賢明です。 通常は、パブリッシュシステムの一部のみを更新し、他のシステムは引き続きトラフィックをアクティブに提供し、テスト後に他のパーツに切り替えます。 運が良く、デプロイメントプロセスでロードバランサーにアクセスできる場合は、メンテナンス中のサーバーへのルーティングを無効にできます。 直接アクセス権のない共有ロードバランサーを使用している場合は、更新するパブリッシュのDispatcherをシャットダウンします。 あればあるほど、シャットダウンする必要があります。 数が多く、頻繁な更新を計画している場合は、自動化をお勧めします。 自動化ツールがない場合は、スケールアウトは悪いアイデアです。

以前のプロジェクトでは、ロードバランサー自体に直接アクセスすることなく、パブリッシュシステムをロードバランシングから削除する別の方法を使用しました。

ロードバランサーは通常、「ping」と呼ばれ、サーバーが起動して実行されているかどうかを確認する特定のページです。 簡単な選択は、通常、ホームページにpingを送信することです。 しかし、pingを使用してロードバランサーにトラフィックのバランスを取らないように信号を送る場合は、他の何かを選択します。 `"up"`または`"down"`（本文またはhttp応答コード）で応答するように設定できる専用のテンプレートまたはサーブレットを作成します。 もちろん、そのページの応答はDispatcherにキャッシュしないでください。したがって、常にパブリッシュシステムから新しく取得されます。 次に、このテンプレートまたはサーブレットをチェックするようにロードバランサーを設定すると、パブリッシュを簡単に「フリー」して停止できます。 ロードバランシングに含まれず、更新できます。

#### 世界的な流通

「ワールドワイド配布」は、各パブリッシュシステムの前に複数のDispatcherが配置され、お客様に近づいてパフォーマンスを向上させる「スケールアウト」設定です。 もちろん、このシナリオでは、中央のロードバランサーはなく、DNSおよびGeoIPベースのロードバランシングスキームを使用します。

>[!NOTE]
>
>実際には、そのアプローチでコンテンツ配布ネットワーク(CDN)のようなものを構築しているので、自分で作るのではなく、既製のCDNソリューションを購入することを検討する必要があります。 カスタムCDNの構築と管理は、簡単な作業ではありません。

#### 水平方向の拡大・縮小

ローカルデータセンターでも、各パブリッシュシステムの前に複数のDispatcherが存在する「スケールアウト」トポロジにはいくつかの利点があります。 トラフィック量が多く（キャッシュのヒット率も良い）、Apacheサーバーのパフォーマンスがボトルネックとなっている場合、（CPU、RAM、および高速ディスクを追加して）ハードウェアをもうスケールアップできない場合は、Dispatchersを追加してパフォーマンスを向上できます。 これは「水平スケール」と呼ばれます。 ただし、これには制限があります。特に、トラフィックを頻繁に無効にする場合です。 次の節で効果について説明します。

#### スケールアウトトポロジの制限

プロキシサーバーを追加すると、通常はパフォーマンスが向上します。 ただし、サーバーを追加すると、実際にパフォーマンスが低下する場合があります。 どうやって？ ニュースポータルがあり、毎分新しい記事やページを紹介するとします。 Dispatcherは、「自動無効化」によって無効化します。ページが公開されるたびに、同じサイト上のキャッシュ内のすべてのページが無効化されます。 これは便利な機能です — このシリーズの[第1章](chapter-1.md)で取り上げましたが — また、Webサイトで頻繁に変更を加えると、キャッシュを無効にすることが頻繁に行われます。 パブリッシュインスタンスごとにDispatcherが1つしかない場合は、ページをリクエストする最初の訪問者が、そのページの再キャッシュをトリガーします。 2番目の訪問者は、既にキャッシュされたバージョンを取得しています。

2人のDispatcherがある場合、2人目の訪問者は50%の確率でページがキャッシュされず、そのページが再度レンダリングされると、より大きな遅延が発生します。 1つのパブリッシュにDispatcherがさらに多くなると、事態はさらに悪化します。 発生するのは、パブリッシュサーバーが、各Dispatcherのページを個別に再レンダリングする必要があるので、より多くの読み込みを受け取ることです。

![キャッシュのフラッシュを頻繁に行うスケールアウトシナリオのパフォーマンスが低下しました。](assets/chapter-2/decreased-performance.png)

*キャッシュのフラッシュを頻繁に行うスケールアウトシナリオのパフォーマンスが低下しました。*

<br> 

#### 過大規模な問題の軽減

問題を軽減するために、すべてのDispatcherに対して中央の共有ストレージを使用するか、Apacheサーバーのファイルシステムを同期することを検討します。 限られたファーストハンドエクスペリエンスしか提供できませんが、システムの複雑さが増し、全く新しいクラスのエラーを導入できる準備が整っています。

NFSではいくつかの実験が行われましたが、NFSでは、コンテンツのロックによって大きなパフォーマンスの問題が発生します。 これにより全体的なパフォーマンスが低下しました。

**結論**  — 複数のDispatcherで共通のファイルシステムを共有する方法は、お勧めしません。

パフォーマンスの問題が発生した場合は、パブリッシャーインスタンスのピーク読み込みを避けるために、パブリッシュインスタンスとDispatcherを均等にスケールアップします。 パブリッシュ/ Dispatcherの比率に関するゴールデンルールはありません。リクエストの配分と、パブリケーションの頻度およびキャッシュの無効化に大きく依存します。

訪問者が経験する遅延も懸念する場合は、コンテンツ配信ネットワークの使用、キャッシュの再取得、プリエンプティブキャッシュウォーミング、猶予時間の設定（このシリーズの[第1章](chapter-1.md)で説明）、または[第3部](chapter-3.md)で説明)を検討します。

### 「Cross Connected」の設定

時々見てきたもう1つの設定は、「クロスコネクテッド」の設定です。パブリッシュインスタンスには専用のDispatcherはありませんが、すべてのDispatcherがすべてのパブリッシュシステムに接続されています。

![クロス接続トポロジ：冗長性の向上と複雑さの増大](assets/chapter-2/cross-connected-setup.png)

<br> 

*クロス接続トポロジ：冗長性の向上と複雑さの増大。*

これにより、比較的小さな予算に対して、より冗長性が得られます。 Apacheサーバーの1つがダウンした場合でも、2つのパブリッシュシステムでレンダリング作業を実行できます。 また、パブリッシュシステムの1つがクラッシュした場合でも、キャッシュされた読み込みを提供するDispatcherが2つあります。

しかし、これは価格が付いています。

まず、メンテナンスのために片足を取るのは非常に面倒です。 実は、この計画はこういう目的で設計されたのです。より耐障害性が高く、あらゆる手段で稼働し続ける。 これをどう扱うかについて、複雑なメンテナンス計画を見てきました。 最初にDispatcher 2を再設定し、クロス接続を削除します。 Dispatcher 2を再起動します。 Dispatcher 1のシャットダウン、パブリッシュ1の更新など。 2本以上の脚に拡大する場合は注意が必要です。 この結論に至るまでに、それは実際に複雑さ、コストを増加させ、人間の誤りの恐ろしい原因となると考えています。 これを自動化する方が良いでしょう。 より良いチェックを行いますこの自動化タスクをプロジェクトスケジュールに組み込む人事が実際にある場合 これにより、ハードウェアコストを削減できますが、ITスタッフの負担が倍になる場合があります。

2つ目は、AEM上で何らかのユーザーアプリケーションが実行され、ログインが必要な場合です。 スティッキーセッションを使用すると、1人のユーザーが常に同じAEMインスタンスから提供され、そのインスタンスでセッション状態を維持できます。 このクロス接続セットアップを使用する場合は、ロードバランサーとDispatcherでスティッキーセッションが正しく動作していることを確認する必要があります。 不可能ではありません。しかし、それを認識し、追加の構成とテスト時間を追加する必要があります。これもまた、ハードウェアの節約によって計画したコストを削減できる可能性があります。

### まとめ

このクロスコネクトスキームをデフォルトオプションとして使用することはお勧めしません。 ただし、使用する場合は、リスクと隠れたコストを慎重に評価し、構成の自動化をプロジェクトの一部として組み込む計画を立てる必要があります。

## 次のステップ

* [3 — キャッシュに関する詳細トピック](chapter-3.md)
